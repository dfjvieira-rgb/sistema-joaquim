<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>SCANNER ELITE - RADAR</title>
    <style>
        :root { --gold: #fbbf24; --bg: #000; --danger: #ef4444; --success: #22c55e; }
        body { 
            background: var(--bg); color: white; font-family: 'Courier New', monospace;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden; border: 2px solid var(--gold);
        }
        #btn-close {
            position: fixed; top: 10px; right: 10px; background: var(--danger);
            color: white; border: none; border-radius: 50%; width: 25px; height: 25px;
            cursor: pointer; font-weight: bold; z-index: 100;
        }
        #radar-circle {
            width: 220px; height: 220px; border: 2px solid var(--gold);
            border-radius: 50%; position: relative; display: flex;
            align-items: center; justify-content: center; flex-direction: column;
            transition: 0.5s;
        }
        .sweep {
            position: absolute; width: 50%; height: 2px; background: var(--gold);
            top: 50%; left: 50%; transform-origin: left;
            animation: rotate 2s linear infinite; opacity: 0.4;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        #peca-detectada { font-size: 0.85rem; font-weight: 900; color: var(--gold); text-align: center; margin-top: 15px; padding: 0 10px; text-transform: uppercase; }
        #info-exame { font-size: 0.6rem; color: #64748b; margin-top: 5px; }
        #status-espelho { font-size: 0.5rem; color: var(--danger); margin-top: 2px; font-weight: bold; }
        
        .match-active { border-color: var(--success) !important; box-shadow: 0 0 30px var(--success) !important; }
        .success-text { color: var(--success) !important; }
        .espelho-ok { color: var(--success) !important; }
    </style>
</head>
<body>

    <button id="btn-close" onclick="window.close()">X</button>

    <div id="radar-circle">
        <div class="sweep"></div>
        <div id="peca-detectada">AGUARDANDO...</div>
        <div id="info-exame">SISTEMA ATIVO</div>
        <div id="status-espelho">SEM DNA NO ESPELHO</div>
    </div>

    <script type="module">
        import { BANCO_ESPELHOS } from './banco-espelhos.js';
        import { pecas } from './estruturas.js';

        const realizarVarredura = () => {
            const activeEx = localStorage.getItem('activeEx') || "41";
            const textoHome = (localStorage.getItem('radar_input') || "").toUpperCase();
            
            const displayPeca = document.getElementById('peca-detectada');
            const displayExame = document.getElementById('info-exame');
            const displayEspelho = document.getElementById('status-espelho');
            const circle = document.getElementById('radar-circle');

            // 1. CRIA O DICIONÁRIO A PARTIR DAS ESTRUTURAS (Para refinar a busca)
            const dicionarioPecas = Object.keys(pecas).map(k => k.toUpperCase());

            // 2. BUSCA NO ESPELHO REAL
            const espelhoReal = (BANCO_ESPELHOS[activeEx] || "").toUpperCase();
            
            // O Radar só aceita a peça se o termo do dicionário existir DENTRO do espelho real
            const pecaValidadaNoEspelho = dicionarioPecas.find(termo => espelhoReal.includes(termo));

            if (pecaValidadaNoEspelho) {
                displayExame.innerText = `EXAME ${activeEx}`;
                displayEspelho.innerText = "DNA CONFIRMADO NO ESPELHO";
                displayEspelho.className = "espelho-ok";

                // 3. CRUZAMENTO COM A HOME: O usuário está escrevendo a peça que o espelho exige?
                if (textoHome.includes(pecaValidadaNoEspelho)) {
                    displayPeca.innerText = pecaValidadaNoEspelho;
                    displayPeca.classList.add('success-text');
                    circle.classList.add('match-active');
                } else {
                    displayPeca.innerText = "ALVO LOCALIZADO";
                    displayPeca.classList.remove('success-text');
                    circle.classList.remove('match-active');
                }
            } else {
                // Caso o espelho não contenha nenhuma das peças do seu dicionário
                displayPeca.innerText = "PEÇA NÃO ENCONTRADA";
                displayExame.innerText = `EXAME ${activeEx}`;
                displayEspelho.innerText = "DIVERGÊNCIA NO ESPELHO";
                displayEspelho.className = "";
                circle.classList.remove('match-active');
            }
        };

        // Escuta a Home
        window.addEventListener('storage', (e) => {
            if (e.key === 'radar_input' || e.key === 'activeEx') realizarVarredura();
        });
        
        window.onload = realizarVarredura;
    </script>
</body>
</html>
