<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>SCANNER ELITE - RADAR</title>
    <style>
        :root { --gold: #fbbf24; --bg: #000; --danger: #ef4444; --success: #22c55e; }
        body { 
            background: var(--bg); color: white; font-family: 'Courier New', monospace;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden; border: 4px solid var(--gold);
        }
        #btn-close {
            position: fixed; top: 10px; right: 10px; background: var(--danger);
            color: white; border: none; border-radius: 50%; width: 25px; height: 25px;
            cursor: pointer; font-weight: bold; z-index: 100;
        }
        #radar-circle {
            width: 220px; height: 220px; border: 2px solid var(--gold);
            border-radius: 50%; position: relative; display: flex;
            align-items: center; justify-content: center; flex-direction: column;
            transition: 0.5s;
        }
        .sweep {
            position: absolute; width: 50%; height: 2px; background: var(--gold);
            top: 50%; left: 50%; transform-origin: left;
            animation: rotate 2s linear infinite; opacity: 0.4;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        #peca-detectada { font-size: 1rem; font-weight: 900; color: var(--gold); text-align: center; margin-top: 15px; padding: 0 10px; text-transform: uppercase; }
        #info-exame { font-size: 0.6rem; color: #64748b; margin-top: 5px; }
        #fonte-status { font-size: 0.5rem; color: var(--gold); opacity: 0.6; margin-top: 2px; font-style: italic; }
        
        .match-active { border-color: var(--success) !important; box-shadow: 0 0 30px var(--success) !important; }
        .success-text { color: var(--success) !important; }
    </style>
</head>
<body>

    <button id="btn-close" onclick="window.close()">X</button>

    <div id="radar-circle">
        <div class="sweep"></div>
        <div id="peca-detectada">SINCRO...</div>
        <div id="info-exame">AGUARDANDO</div>
        <div id="fonte-status">SISTEMA OFF</div>
    </div>

    <script type="module">
        import { BANCO_ESPELHOS } from './banco-espelhos.js';
        import { pecas } from './estruturas.js';

        // Termos técnicos reais para cruzamento
        const TERMOS_TECNICOS = ["CONTESTAÇÃO", "RECURSO ORDINÁRIO", "RECLAMAÇÃO", "AGRAVO DE PETIÇÃO", "MANDADO DE SEGURANÇA", "AÇÃO DE CONSIGNAÇÃO", "RECURSO DE REVISTA"];

        const realizarVarredura = () => {
            const activeEx = localStorage.getItem('activeEx') || "44";
            const textoHome = (localStorage.getItem('radar_input') || "").toUpperCase();
            
            const displayPeca = document.getElementById('peca-detectada');
            const displayExame = document.getElementById('info-exame');
            const displayFonte = document.getElementById('fonte-status');
            const circle = document.getElementById('radar-circle');

            let alvoReal = null;
            let fonteIdentificada = "";

            // 1. BUSCA DADO REAL NO ESPELHO (Conteúdo)
            const conteudoEspelho = (BANCO_ESPELHOS[activeEx] || "").toUpperCase();
            alvoReal = TERMOS_TECNICOS.find(termo => conteudoEspelho.includes(termo));

            if (alvoReal) {
                fonteIdentificada = "DB: ESPELHO FGV";
            } else {
                // 2. BUSCA DADO REAL NO BANCO DE ESTRUTURAS (Nomes das Peças)
                const listaEstruturas = Object.keys(pecas).map(k => k.toUpperCase());
                alvoReal = TERMOS_TECNICOS.find(termo => listaEstruturas.some(nome => nome.includes(termo)));
                
                if (alvoReal) fonteIdentificada = "DB: ESTRUTURAS";
            }

            // ATUALIZAÇÃO DO RADAR
            if (alvoReal) {
                displayExame.innerText = `EXAME ${activeEx}`;
                displayFonte.innerText = fonteIdentificada;

                // Valida se o que foi escrito na Home "bate" com o dado real encontrado
                if (textoHome.includes(alvoReal)) {
                    displayPeca.innerText = alvoReal;
                    displayPeca.classList.add('success-text');
                    circle.classList.add('match-active');
                } else {
                    displayPeca.innerText = "ALVO PENDENTE";
                    displayPeca.classList.remove('success-text');
                    circle.classList.remove('match-active');
                }
            } else {
                displayPeca.innerText = "SEM ALVO";
                displayExame.innerText = `EXAME ${activeEx}`;
                displayFonte.innerText = "DADO NÃO LOCALIZADO";
            }
        };

        window.addEventListener('storage', realizarVarredura);
        window.onload = realizarVarredura;
    </script>
</body>
</html>
