<script type="module">
    // 1. Importa√ß√£o direta dos m√≥dulos oficiais do Firebase
    import { initializeApp } from "https://www.gstatic.com";
    import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // 2. Configura√ß√£o consolidada (substituindo o externo firebase-config.js)
    const firebaseConfig = {
        apiKey: "AIzaSyAmigODFK8R9c0-fWtagdxLWu9xkODfKYQ",
        authDomain: "masteroab-db5e1.firebaseapp.com",
        projectId: "masteroab-db5e1",
        databaseURL: "https://masteroab-db5e1-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 3. Exposi√ß√£o das fun√ß√µes ao escopo Global (window) para os bot√µes HTML
    window.db = db;
    window.ref = ref;
    window.set = set;
    window.onValue = onValue;
    window.push = push;

    // Fallbacks para arquivos externos caso n√£o carreguem
    window.BANCO_ESPELHOS = window.BANCO_ESPELHOS || {};
    window.pecas_data = window.pecas_data || { "Estrutura Base": "EXCELENT√çSSIMO SENHOR DOUTOR JUIZ..." };

    let activeEx = "41";
    let currentMode = null;
    const editor = document.getElementById('main-editor');
    const radar = document.getElementById('radar-peca');

    // --- ATIVA√á√ÉO DO BOT√ÉO FOGUETE (SNAPSHOT) ---
    window.gerarSnapshot = () => {
        const nomePeca = radar.innerText || "PE√áA N√ÉO IDENTIFICADA";
        const textoConteudo = editor.innerText;
        const dataRef = new Date().toLocaleString('pt-BR');

        if (!textoConteudo || textoConteudo.trim().length < 10) {
            return alert("‚ö†Ô∏è O editor est√° muito curto para gerar um snapshot!");
        }

        // Refer√™ncia: historico_envios / N√∫mero do Exame (ex: 41)
        const historicoRef = window.ref(window.db, 'historico_envios/' + activeEx);
        
        window.push(historicoRef, {
            peca_nome: nomePeca,
            conteudo: textoConteudo,
            data: dataRef,
            timestamp: Date.now()
        })
        .then(() => {
            alert("üöÄ SUCESSO! Pe√ßa enviada ao hist√≥rico da Mentoria.");
            // Feedback visual no radar
            radar.style.color = "#22c55e";
            setTimeout(() => radar.style.color = "var(--gold)", 2000);
        })
        .catch(err => {
            console.error(err);
            alert("‚ùå Erro ao salvar: " + err.message);
        });
    };

    // --- DEMAIS FUN√á√ïES DO SISTEMA ---
    window.salvarManual = () => {
        window.set(window.ref(window.db, 'estudos/' + activeEx), { 
            text: editor.innerText, 
            ts: Date.now() 
        }).then(() => alert("‚úÖ Rascunho salvo!"));
    };

    window.autoSave = () => {
        window.set(window.ref(window.db, 'estudos/' + activeEx), { 
            text: editor.innerText, 
            ts: Date.now() 
        });
    };

    window.toggleTheme = () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };

    const carregarExames = () => {
        const nav = document.getElementById('exam-nav');
        if(!nav) return;
        nav.innerHTML = '';
        for (let i = 44; i >= 35; i--) {
            const btn = document.createElement('div');
            btn.className = `exame-btn ${i == activeEx ? 'active' : ''}`;
            btn.innerText = `E${i}`;
            btn.onclick = () => {
                activeEx = i.toString();
                carregarExames();
                carregarFirebase();
            };
            nav.appendChild(btn);
        }
    };

    function carregarFirebase() {
        window.onValue(window.ref(window.db, 'estudos/' + activeEx), (s) => {
            const d = s.val();
            if(d && d.text && document.activeElement !== editor) {
                editor.innerText = d.text;
            }
        }, { onlyOnce: true });
    }

    // Inicializa√ß√£o
    carregarExames();
    carregarFirebase();
    editor.addEventListener('input', window.autoSave);
</script>
