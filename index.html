<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aryanna Master Pro 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { width: 280px; background: var(--primary); color: white; padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10; overflow-y: auto; }
        .btn-peca { background: #34495e; border: none; color: white; padding: 10px; text-align: left; cursor: pointer; border-radius: 4px; font-size: 13px; }
        .btn-peca:hover { background: var(--accent); }

        #main-content { flex: 1; display: flex; flex-direction: column; padding: 15px; gap: 10px; background: #e8ecef; }
        #editor { flex: 1; padding: 25px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; line-height: 1.6; resize: none; font-family: 'Times New Roman', serif; }

        /* Painel PDF Otimizado */
        #pdf-panel { flex: 1.2; background: #525659; display: flex; flex-direction: column; border-left: 2px solid #333; }
        #pdf-controls { background: #333; color: white; padding: 8px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        #pdf-viewer { flex: 1; overflow: auto; position: relative; background: #525659; display: flex; justify-content: center; }
        
        /* Camada de sele√ß√£o de texto */
        .pdf-page-wrapper { position: relative; margin: 15px auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); background: white; }
        .textLayer { opacity: 1; mix-blend-mode: multiply; } 

        #espelho-container { width: 320px; background: white; border-left: 1px solid #ddd; padding: 15px; overflow-y: auto; }
        .espelho-item { display: flex; gap: 8px; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 12px; }
        #nota-final { font-size: 22px; font-weight: bold; text-align: center; padding: 15px; background: var(--primary); color: white; border-radius: 6px; margin-top: 10px; }
        .post-it { background: #fff9c4; padding: 10px; border-radius: 4px; font-size: 13px; margin-bottom: 8px; border-left: 4px solid #fbc02d; color: #333; }
    </style>
</head>
<body>

    <aside id="sidebar">
        <h3>Pe√ßas Base</h3>
        <button class="btn-peca" onclick="carregarEstrutura('RT')">Reclama√ß√£o Trabalhista</button>
        <button class="btn-peca" onclick="carregarEstrutura('CON')">Contesta√ß√£o</button>
        <button class="btn-peca" onclick="carregarEstrutura('RO')">Recurso Ordin√°rio</button>
        <hr>
        <div id="meus-postits"></div>
        <button class="btn-peca" style="background:var(--accent)" onclick="addPostIt()">+ Novo Post-it</button>
        <hr>
        <label>Vade Mecum (PDF):</label>
        <input type="file" id="file-upload" accept="application/pdf">
    </aside>

    <main id="main-content">
        <div style="display:flex; justify-content:space-between;">
            <select id="select-espelho" onchange="window.carregarEspelho(this.value)">
                <option value="">Escolher Espelho...</option>
                <option value="44">44¬∫ Exame</option>
                <option value="41">41¬∫ Exame</option>
                <option value="40">40¬∫ Exame</option>
                <option value="37">37¬∫ Exame</option>
                <option value="35">35¬∫ Exame</option>
            </select>
            <button onclick="salvarProgresso()">üíæ Salvar Treino</button>
        </div>
        <textarea id="editor" placeholder="Inicie sua pe√ßa..."></textarea>
    </main>

    <section id="pdf-panel">
        <div id="pdf-controls">
            <button class="btn-peca" onclick="changePage(-1)">‚ùÆ Anterior</button>
            <input type="number" id="page-num" value="1" min="1" style="width:50px; text-align:center;" onchange="goToPage(this.value)">
            <span>/ <span id="page-count">0</span></span>
            <button class="btn-peca" onclick="changePage(1)">Pr√≥xima ‚ùØ</button>
        </div>
        <div id="pdf-viewer">
            <div id="wrapper" class="pdf-page-wrapper">
                <canvas id="pdf-canvas"></canvas>
                <div id="text-layer" class="textLayer"></div>
            </div>
        </div>
    </section>

    <section id="espelho-container">
        <div id="itens-espelho"></div>
        <div id="nota-final">Nota: 0,00</div>
    </section>

    <script type="module">
        import { DATA_MASTER } from './estruturas.js';

        // Configura√ß√µes PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null, pageNum = 1, pageRendering = false;
        const scale = 1.5;

        async function renderPage(num) {
            pageRendering = true;
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale });
            
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            // 1. Renderiza a imagem
            await page.render({ canvasContext: context, viewport: viewport }).promise;

            // 2. Renderiza a camada de texto (Cir√∫rgico: Habilita C√≥pia)
            const textLayerDiv = document.getElementById('text-layer');
            textLayerDiv.innerHTML = "";
            textLayerDiv.style.height = viewport.height + "px";
            textLayerDiv.style.width = viewport.width + "px";
            
            const textContent = await page.getTextContent();
            pdfjsLib.renderTextLayer({
                textContent: textContent,
                container: textLayerDiv,
                viewport: viewport,
                textDivs: []
            });

            pageRendering = false;
            document.getElementById('page-num').value = num;
        }

        window.changePage = (offset) => {
            if (!pdfDoc || pageRendering) return;
            const next = pageNum + offset;
            if (next >= 1 && next <= pdfDoc.numPages) { pageNum = next; renderPage(pageNum); }
        };

        window.goToPage = (n) => {
            if (pdfDoc && n >= 1 && n <= pdfDoc.numPages) { pageNum = parseInt(n); renderPage(pageNum); }
        };

        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const buffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(buffer).promise;
                document.getElementById('page-count').textContent = pdfDoc.numPages;
                renderPage(1);
            }
        });

        // Interface e Persist√™ncia
        window.carregarEstrutura = (t) => document.getElementById('editor').value = DATA_MASTER.estruturas[t];
        window.carregarEspelho = (id) => {
            document.getElementById('itens-espelho').innerHTML = DATA_MASTER.espelhos[id];
            window.calcNota();
        };
        window.calcNota = () => {
            let total = 0;
            document.querySelectorAll('#itens-espelho input:checked').forEach(i => total += parseFloat(i.value));
            document.getElementById('nota-final').innerText = `Nota: ${total.toFixed(2)}`;
        };
        window.addPostIt = () => {
            const m = prompt("Dica:");
            if(m) {
                const d = document.createElement('div'); d.className='post-it'; d.innerText=`üìå ${m}`;
                document.getElementById('meus-postits').appendChild(d);
                localStorage.setItem('postits', document.getElementById('meus-postits').innerHTML);
            }
        };
        window.salvarProgresso = () => {
            localStorage.setItem('draft', document.getElementById('editor').value);
            alert("Treino salvo!");
        };
        window.onload = () => {
            document.getElementById('editor').value = localStorage.getItem('draft') || "";
            document.getElementById('meus-postits').innerHTML = localStorage.getItem('postits') || "";
        };
    </script>
</body>
</html>
