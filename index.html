<script type="module">
    import { db } from './firebase-config.js';
    import { ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { BANCO_ESPELHOS } from './banco-espelhos.js';
    import { pecas } from './estruturas.js';

    let activeEx = localStorage.getItem('activeEx') || "44";
    let ultimaLinhaFocada = 1;
    const folha = document.getElementById('folha-total');

    // --- ESCÂNER REFINADO (O Cérebro do Radar) ---
    const escaneamentoPro = () => {
        const radar = document.getElementById('radar-container');
        const status = document.getElementById('radar-status');
        // Puxa o texto do seu banco de espelhos
        const textoGabarito = (BANCO_ESPELHOS[activeEx] || "").toUpperCase();

        radar.className = ''; // Limpa cores anteriores
        
        if (!textoGabarito) {
            status.innerText = "EXAME " + activeEx + "\nSEM GABARITO";
            return;
        }

        const buscas = [
            { nome: "RECURSO ORDINÁRIO", keys: ["ORDINÁRIO", "895", "RO "], cor: "radar-recurso" },
            { nome: "CONTESTAÇÃO", keys: ["CONTESTAÇÃO", "847", "ART. 847"], cor: "radar-defesa" },
            { nome: "RECLAMAÇÃO TRAB.", keys: ["RECLAMAÇÃO", "840", "RT "], cor: "radar-inicial" },
            { nome: "CONSIGNAÇÃO", keys: ["CONSIGNAÇÃO", "PAGAMENTO"], cor: "radar-inicial" },
            { nome: "AGRAVO DE PETIÇÃO", keys: ["AGRAVO", "897"], cor: "radar-recurso" }
        ];

        let achou = buscas.find(b => b.keys.some(k => textoGabarito.includes(k)));

        if (achou) {
            status.innerText = achou.nome;
            radar.classList.add(achou.cor);
        } else {
            status.innerText = "PEÇA\nIDENTIFICADA";
            radar.style.borderColor = "var(--gold)";
        }
    };

    const criarFolha = () => {
        folha.innerHTML = '';
        for(let i=1; i<=180; i++) {
            if(i === 1) folha.innerHTML += '<div class="fgv-header">PEÇA PROFISSIONAL</div>';
            if(i === 51) folha.innerHTML += '<div class="fgv-header">QUESTÃO 1</div>';
            
            const wrap = document.createElement('div');
            wrap.className = 'linha-wrapper';
            wrap.innerHTML = `
                <div class="linha-num">${i}</div>
                <input class="linha-folha" id="L${i}" maxlength="85" autocomplete="off">
            `;
            const input = wrap.querySelector('input');
            input.onfocus = () => ultimaLinhaFocada = i;
            // Salva no Firebase ao digitar
            input.onblur = () => salvar(); 
            folha.appendChild(wrap);
        }
    };

    const salvar = () => {
        const dados = Array.from(document.querySelectorAll('.linha-folha')).map(l => l.value);
        set(ref(db, 'estudos/' + activeEx), { linhas: dados, ts: Date.now() });
    };

    const carregarFirebase = () => {
        onValue(ref(db, 'estudos/' + activeEx), (s) => {
            const d = s.val();
            const inputs = document.querySelectorAll('.linha-folha');
            if(d && d.linhas) {
                d.linhas.forEach((txt, i) => { if(inputs[i]) inputs[i].value = txt; });
            } else {
                inputs.forEach(l => l.value = '');
            }
            escaneamentoPro(); // Atualiza o Radar após carregar
        }, { onlyOnce: true });
    };

    // FUNÇÕES TORNADAS GLOBAIS PARA OS BOTÕES FUNCIONAREM
    window.abrirModal = (tipo) => {
        const content = document.getElementById('modal-content');
        const header = document.getElementById('modal-header');
        content.innerHTML = '';
        
        if(tipo === 'exames') {
            header.innerText = "SELECIONE O EXAME";
            for(let i=44; i>=35; i--) {
                const b = document.createElement('div'); b.className='opt-btn'; b.innerText=`EXAME ${i}`;
                b.onclick = () => { 
                    activeEx = i.toString(); 
                    localStorage.setItem('activeEx', activeEx);
                    carregarFirebase(); 
                    fecharModal(); 
                };
                content.appendChild(b);
            }
        } else if(tipo === 'pecas') {
            header.innerText = "ESTRUTURAS (SCROLL)";
            Object.keys(pecas).forEach(k => {
                const b = document.createElement('div'); b.className='opt-btn'; b.innerText=k.toUpperCase();
                b.onclick = () => { 
                    pecas[k].split('\n').forEach((txt, idx) => {
                        const el = document.getElementById(`L${ultimaLinhaFocada + idx}`);
                        if(el) el.value = txt.trim().substring(0, 85);
                    });
                    salvar(); fecharModal(); 
                };
                content.appendChild(b);
            });
        }
        document.getElementById('universal-modal').style.display = 'flex';
    };

    window.injetarJustica = () => {
        const esp = BANCO_ESPELHOS[activeEx] || BANCO_ESPELHOS[parseInt(activeEx)];
        if(!esp) return alert("Gabarito não encontrado para o Exame " + activeEx);
        
        const frases = esp.split('\n').filter(f => f.trim().length > 5);
        frases.forEach((frase, index) => {
            const el = document.getElementById(`L${ultimaLinhaFocada + index}`);
            if(el) el.value = "➤ " + frase.trim().substring(0, 80);
        });
        salvar();
    };

    window.fecharModal = () => document.getElementById('universal-modal').style.display = 'none';
    
    window.resetarTudo = () => { 
        if(confirm("Deseja apagar toda a folha do Exame " + activeEx + "?")) { 
            document.querySelectorAll('.linha-folha').forEach(l => l.value = ''); 
            salvar(); 
        }
    };

    // Inicialização
    criarFolha();
    carregarFirebase();
</script>
