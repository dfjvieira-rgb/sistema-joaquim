// --- MONTAGEM DA FOLHA ATUALIZADA ---
const montarFolha = () => {
    const container = document.getElementById('folha-total');
    container.innerHTML = "";
    for(let i=1; i<=180; i++) {
        if(i === 1 || i === 51) {
            const h = document.createElement('div');
            h.style.cssText = "background:#1e293b; color:#fbbf24; padding:8px; text-align:center; font-size:0.7rem; font-weight:bold;";
            h.innerText = i === 1 ? 'CADERNO DE RESPOSTAS - PEÇA' : 'CADERNO DE RESPOSTAS - QUESTÕES';
            container.appendChild(h);
        }
        const row = document.createElement('div');
        row.className = 'linha-wrapper';
        const input = document.createElement('input');
        input.className = 'linha-folha';
        input.id = `L${i}`;
        input.setAttribute('spellcheck', 'false');
        input.onkeydown = (e) => { if (e.key === "Enter") { e.preventDefault(); document.getElementById(`L${i + 1}`)?.focus(); } };
        input.onfocus = () => { ultimaLinhaFocada = i; };
        row.innerHTML = `<div class="linha-num">${i}</div>`;
        row.appendChild(input);
        container.appendChild(row);
    }
    // Aqui ele busca os dados E já roda o scanner logo em seguida
    carregarDados();
};

// --- MODAL DE EXAMES ATUALIZADO (LOCALIZAÇÃO DIRETA) ---
window.abrirModalExames = () => {
    const content = document.getElementById('modal-content');
    content.innerHTML = `<h2 style="text-align:center; margin-bottom:15px;">SELECIONAR EXAME</h2>`;
    const grid = document.createElement('div'); 
    grid.style.display="grid"; 
    grid.style.gridTemplateColumns="1fr 1fr"; 
    grid.style.gap="10px";

    for(let i=44; i>=35; i--) {
        const b = document.createElement('div'); 
        b.className='opt-btn'; 
        b.innerText=`Exame ${i}`;
        b.onclick = () => { 
            activeEx = i.toString(); 
            localStorage.setItem('activeEx', activeEx); 
            
            // 1. Monta a folha limpa
            montarFolha(); 
            
            // 2. Força o scanner a ler o banco de espelhos do novo exame imediatamente
            escaneamentoElite(); 
            
            fecharModal(); 
        };
        grid.appendChild(b);
    }
    content.appendChild(grid);
    document.getElementById('universal-modal').style.display='flex';
};
