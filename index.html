<script type="module">
    import { db } from './firebase-config.js';
    import { ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { BANCO_ESPELHOS } from './banco-espelhos.js';
    import { pecas } from './estruturas.js';

    let activeEx = localStorage.getItem('activeEx') || "44";
    let ultimaLinhaFocada = 1;
    const LIMITE_LINHA = 85;

    // --- SCANNER RECONSTRUIDO (FOR√áA BRUTA) ---
    const rodarScanner = () => {
        const status = document.getElementById('radar-status');
        const box = document.getElementById('radar-container');
        const topo = document.getElementById('identificador-peca');
        
        // Pega o conte√∫do do espelho e limpa tags HTML/Espa√ßos
        const conteudoBruto = BANCO_ESPELHOS[activeEx] || "";
        const dnaLimpo = conteudoBruto.replace(/<[^>]*>/g, '').toUpperCase();

        const PECAS_DNA = [
            { id: "RECURSO ORDIN√ÅRIO", display: "RECURSO ORDIN√ÅRIO", cor: "#3b82f6" },
            { id: "CONTESTA√á√ÉO", display: "CONTESTA√á√ÉO", cor: "#22c55e" },
            { id: "RECLAMA√á√ÉO", display: "RECLAMA√á√ÉO TRABALHISTA", cor: "#a855f7" },
            { id: "AGRAVO DE PETI√á√ÉO", display: "AGRAVO DE PETI√á√ÉO", cor: "#f87171" },
            { id: "MANDADO DE SEGURAN√áA", display: "MANDADO DE SEGURAN√áA", cor: "#06b6d4" },
            { id: "CONSIGNAT√ìRIA", display: "CONSIGNAT√ìRIA", cor: "#fbbf24" }
        ];

        // Busca exata no DNA do Espelho
        const alvo = PECAS_DNA.find(p => dnaLimpo.includes(p.id));

        if (alvo) {
            status.innerHTML = `<span style="color:${alvo.cor}">ALVO DETECTADO</span><br>${alvo.id}`;
            box.style.borderColor = alvo.cor;
            box.classList.remove('radar-blink');
            topo.innerText = `EXAME ${activeEx}: ${alvo.display}`;
            topo.style.color = alvo.cor;
            topo.style.borderBottom = `3px solid ${alvo.cor}`;
        } else {
            status.innerHTML = `SCANNER<br><span class="radar-blink">BUSCANDO NO ESPELHO...</span>`;
            box.style.borderColor = "var(--gold)";
            topo.innerText = `EXAME ${activeEx}: SEM PE√áA DEFINIDA`;
            topo.style.color = "#64748b";
            topo.style.borderBottom = `3px double var(--line-color)`;
        }
    };

    // --- MONTAGEM DA FOLHA ---
    window.montarFolha = () => {
        const container = document.getElementById('folha-total');
        container.innerHTML = "";
        for(let i=1; i<=180; i++) {
            const row = document.createElement('div');
            row.className = 'linha-wrapper';
            row.innerHTML = `<div class="linha-num">${i}</div>`;
            const input = document.createElement('input');
            input.className = 'linha-folha';
            input.id = `L${i}`;
            input.setAttribute('maxlength', LIMITE_LINHA);
            input.setAttribute('spellcheck', 'false');
            
            input.onfocus = () => { ultimaLinhaFocada = i; };
            input.oninput = () => {
                if (input.value.length >= LIMITE_LINHA) document.getElementById(`L${i+1}`)?.focus();
            };
            input.onkeydown = (e) => {
                if (e.key === "Enter") { e.preventDefault(); document.getElementById(`L${i+1}`)?.focus(); }
                if (e.key === "Backspace" && input.value === "") document.getElementById(`L${i-1}`)?.focus();
            };
            row.appendChild(input);
            container.appendChild(row);
        }
        carregarDados();
        rodarScanner(); // For√ßa o scanner ao montar
    };

    const carregarDados = () => {
        onValue(ref(db, `estudos/${activeEx}`), (snap) => {
            const d = snap.val();
            if (d && d.linhas) {
                d.linhas.forEach((txt, idx) => {
                    const el = document.getElementById(`L${idx + 1}`);
                    if (el) el.value = txt;
                });
            }
        }, { onlyOnce: true });
    };

    window.disqueteSalvarPDF = () => {
        const dados = Array.from(document.querySelectorAll('.linha-folha')).map(i => i.value);
        const historicoRef = ref(db, 'mentoria/historico');
        push(historicoRef, {
            exame: activeEx,
            peca: document.getElementById('identificador-peca').innerText,
            conteudo: dados,
            ts: Date.now()
        }).then(() => {
            alert("üíæ PDF SALVO NO HIST√ìRICO!");
            set(ref(db, `estudos/${activeEx}`), { linhas: dados, ts: Date.now() });
        });
    };

    window.abrirModalExames = () => {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<h3 style="text-align:center; margin-bottom:15px;">MUDAR EXAME</h3>`;
        const grid = document.createElement('div'); grid.style.cssText="display:grid; grid-template-columns:1fr 1fr; gap:10px;";
        [45,44,43,42,41,40,39,38,37,36,35].forEach(i => {
            const b = document.createElement('div'); b.className='opt-btn'; b.innerText=`Exame ${i}`;
            if(i.toString() === activeEx) b.style.background = "var(--gold)";
            b.onclick = () => { 
                activeEx = i.toString(); 
                localStorage.setItem('activeEx', activeEx); 
                montarFolha(); 
                fecharModal(); 
            };
            grid.appendChild(b);
        });
        content.appendChild(grid);
        document.getElementById('universal-modal').style.display='flex';
    };

    // Outras fun√ß√µes auxiliares
    window.fecharModal = () => document.getElementById('universal-modal').style.display='none';
    window.fecharSplitPdf = () => document.getElementById('pdf-split-view').classList.remove('active');
    window.abrirSplitPdf = (t) => {
        document.getElementById('pdf-frame').src = t === 'v' ? 'vade.pdf' : `ro${activeEx}${t === 'g' ? '-gabarito' : ''}.pdf`;
        document.getElementById('pdf-split-view').classList.add('active');
    };
    window.irPara = (n) => document.getElementById(`L${n}`)?.scrollIntoView({behavior:'smooth', block:'center'});
    window.resetarFolha = () => { if(confirm("Limpar?")) document.querySelectorAll('.linha-folha').forEach(i => i.value=""); rodarScanner(); };

    window.onload = () => montarFolha();
    Object.assign(window, { abrirModalExames, fecharModal, fecharSplitPdf, abrirSplitPdf, irPara, resetarFolha, disqueteSalvarPDF });
</script>
