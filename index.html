<script type="module">
    import { db } from './firebase-config.js';
    import { ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { BANCO_ESPELHOS } from './banco-espelhos.js';
    import { pecas } from './estruturas.js';

    let activeEx = localStorage.getItem('activeEx') || "44";
    let ultimaLinha = 1;

    // --- 1. LÓGICA DO RADAR RESTRUTURADA (A SUA!) ---
    const atualizarRadar = () => {
        const txt = (BANCO_ESPELHOS[activeEx] || "").toUpperCase();
        const radarStatus = document.getElementById('radar-status');
        const radarBox = document.getElementById('radar-container');

        if (!radarStatus || !radarBox) return;

        const DICIONARIO = [
            { id: "AGRAVO DE PETIÇÃO", display: "AGRAVO PETIÇÃO", cor: "#f87171" },
            { id: "RECURSO ORDINÁRIO", display: "REC. ORDINÁRIO", cor: "#3b82f6" },
            { id: "CONTESTAÇÃO", display: "CONTESTAÇÃO", cor: "#22c55e" },
            { id: "RECLAMAÇÃO", display: "RECLAMATÓRIA", cor: "#a855f7" }
        ];

        let achou = DICIONARIO.find(i => txt.includes(i.id));

        if (achou) {
            radarStatus.innerHTML = `<span style="color:${achou.cor}; font-weight:900;">RADAR</span><br><span style="font-size:0.6rem; color:#fff;">${achou.display}</span>`;
            radarBox.style.borderColor = achou.cor;
            radarBox.style.boxShadow = `0 0 20px ${achou.cor}66`;
        } else {
            radarStatus.innerHTML = `<span>RADAR</span><br><span style="font-size:0.5rem; opacity:0.6; color:#fff;">VARRENDO...</span>`;
            radarBox.style.borderColor = "var(--gold)";
            radarBox.style.boxShadow = "none";
        }
    };

    // --- 2. NAVEGAÇÃO DE EXAMES (TRIGGER E44-E35) ---
    window.abrirModalExames = () => {
        const container = document.getElementById('modal-content');
        const header = document.getElementById('modal-header');
        header.innerText = "SELECIONAR MISSÃO";
        container.innerHTML = '';
        
        const grid = document.createElement('div');
        grid.style.cssText = 'display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;';

        for(let i=44; i>=35; i--) {
            const b = document.createElement('div');
            const isActive = (i == activeEx);
            b.style.cssText = `
                padding: 15px 5px; text-align: center; border-radius: 8px; border: 2px solid ${isActive ? 'var(--gold)' : '#ddd'};
                cursor: pointer; font-weight: 900; background: ${isActive ? 'var(--primary)' : '#f8fafc'};
                color: ${isActive ? 'var(--gold)' : '#334155'};
            `;
            b.innerText = `E${i}`;
            b.onclick = () => { 
                activeEx = i.toString(); 
                localStorage.setItem('activeEx', i);
                carregarFirebase(); 
                fecharModal(); 
            };
            grid.appendChild(b);
        }
        container.appendChild(grid);
        document.getElementById('universal-modal').style.display = 'flex';
    };

    // --- 3. CORE DO SISTEMA ---
    const criarFolha = () => {
        const corpo = document.getElementById('folha-total');
        corpo.innerHTML = '';
        for(let i=1; i<=180; i++) {
            const wrap = document.createElement('div');
            wrap.className = 'linha-wrapper';
            wrap.innerHTML = `<div class="linha-num">${i}</div><input class="linha-folha" id="L${i}" maxlength="85" autocomplete="off">`;
            const input = wrap.querySelector('input');
            input.onfocus = () => ultimaLinha = i;
            corpo.appendChild(wrap);
        }
    };

    const carregarFirebase = () => {
        onValue(ref(db, 'estudos/' + activeEx), (s) => {
            const d = s.val();
            const inputs = document.querySelectorAll('.linha-folha');
            inputs.forEach((input, i) => { input.value = (d && d.linhas) ? (d.linhas[i] || '') : ''; });
            atualizarRadar();
        }, { onlyOnce: true });
    };

    window.abrirModalPecas = () => {
        const container = document.getElementById('modal-content');
        document.getElementById('modal-header').innerText = "ESTRUTURAS DISPONÍVEIS";
        container.innerHTML = '';
        Object.keys(pecas).forEach(k => {
            const b = document.createElement('div');
            b.className = 'opt-btn';
            b.style.cssText = 'padding:12px; border:1px solid #ddd; margin-bottom:5px; cursor:pointer; font-weight:bold; border-radius:8px; background:#f8fafc; color:#333;';
            b.innerText = k.toUpperCase();
            b.onclick = () => {
                pecas[k].split('\n').forEach((txt, idx) => {
                    const el = document.getElementById(`L${ultimaLinha + idx}`);
                    if(el) el.value = txt.trim().substring(0, 85);
                });
                fecharModal();
            };
            container.appendChild(b);
        });
        document.getElementById('universal-modal').style.display = 'flex';
    };

    window.fecharModal = () => document.getElementById('universal-modal').style.display = 'none';

    // Inicialização
    criarFolha();
    carregarFirebase();
    Object.assign(window, { fecharModal, carregarFirebase });
</script>
