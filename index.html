<script type="module">
    // ... (mantenha suas importações e configs de Firebase iguais)

    // --- CALIBRAÇÃO DA BLACK BOX (ESTUDOS) ---
    onValue(ref(db, 'estudos'), (snap) => {
        const feedBB = document.getElementById('black-box-feed');
        const voos = snap.val();
        feedBB.innerHTML = "";
        
        if(!voos) { 
            feedBB.innerHTML = "<p style='color:gray; font-size:0.8rem;'>Aguardando sinal do radar...</p>"; 
            return; 
        }

        // Ordenar os exames (44, 43, 42...)
        Object.keys(voos).sort((a, b) => b - a).forEach(exId => {
            const voo = voos[exId];
            
            // AJUSTE DE DATA: Se ts não existir ou for inválido, usa a data atual
            const dataVoo = (voo.ts && !isNaN(voo.ts)) 
                ? new Date(voo.ts).toLocaleDateString('pt-BR') 
                : "Data em Processamento";

            // AJUSTE DE TEXTO: Verifica se o campo 'editor-peca' tem conteúdo
            const resumoPeca = (voo['editor-peca'] && voo['editor-peca'].trim() !== "") 
                ? voo['editor-peca'].substring(0, 150) + "..." 
                : "Simulado em andamento (Sem texto ainda)";

            const div = document.createElement('div');
            div.className = 'black-box-item';
            div.style.cursor = "pointer";
            div.innerHTML = `
                <div class="bb-meta">
                    <span>EXAME E${exId}</span>
                    <span><i class="far fa-calendar-alt"></i> ${dataVoo}</span>
                </div>
                <div class="bb-content">${resumoPeca}</div>
                <div style="font-size: 0.55rem; color: #fbbf24; margin-top: 5px; text-align: right; font-weight: bold;">
                    CLIQUE PARA ACESSAR O COCKPIT >
                </div>
            `;
            
            // Ao clicar, ele volta para o cockpit
            div.onclick = () => { location.href = 'index.html'; };
            feedBB.appendChild(div);
        });
    });

    // ... (mantenha o restante do código das Preliminares e Teses)
</script>
