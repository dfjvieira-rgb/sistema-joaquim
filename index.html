<script>
    // Vari√°vel para controle de edi√ß√£o de arquivo
    let pecaEmEdicaoOriginal = null;

    async function finalizarEArquivar() {
        const textoAtual = document.getElementById('texto-final').value;
        if (!textoAtual.trim()) {
            alert("A folha est√° vazia! Escreva algo antes de arquivar.");
            return;
        }

        const titulo = prompt("T√≠tulo para arquivar (ex: RT Exame 40 - Vers√£o 2):", pecaEmEdicaoOriginal || "");
        
        if(titulo) {
            const data = new Date().toLocaleDateString('pt-BR');
            const hora = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            
            await window.push(window.ref(window.db, 'historico_treinos'), {
                titulo: titulo,
                texto: textoAtual,
                data: `${data} √†s ${hora}`,
                exame: exAtual
            });
            
            alert("Pe√ßa arquivada com sucesso no Museu!");
            pecaEmEdicaoOriginal = null; // Reseta o marcador de edi√ß√£o
            resetCompleto();
        }
    }

    async function carregarHistorico() {
        const list = document.getElementById('lista-historico');
        list.innerHTML = "<p style='padding:20px; text-align:center;'>Abrindo o cofre de arquivos...</p>";
        
        try {
            const snap = await window.get(window.ref(window.db, 'historico_treinos'));
            list.innerHTML = "";
            
            if(snap.exists()) {
                // Criar array para mostrar os mais recentes primeiro
                let treinos = [];
                snap.forEach(c => { treinos.unshift({key: c.key, ...c.val()}); });

                treinos.forEach(item => {
                    const d = document.createElement('div');
                    d.style = "padding:15px; border:1px solid #e2e8f0; margin-bottom:10px; border-radius:10px; background:#fff; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);";
                    
                    d.innerHTML = `
                        <div style="flex:1">
                            <strong style="color:var(--pen-blue); font-size:1rem;">${item.titulo}</strong><br>
                            <small style="color:#64748b;">üíæ ${item.data}</small>
                        </div>
                        <button style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:0.7rem;">
                            RESTAURAR üîÑ
                        </button>
                    `;
                    
                    d.onclick = () => {
                        const textoNaFolha = document.getElementById('texto-final').value;
                        if(textoNaFolha.trim() !== "" && !confirm("A folha atual cont√©m texto. Deseja substitu√≠-lo por esta vers√£o do museu?")) {
                            return;
                        }
                        
                        // A√á√ÉO DE RESTAURAR
                        document.getElementById('texto-final').value = item.texto;
                        pecaEmEdicaoOriginal = item.titulo; // Marca que estamos editando esta pe√ßa
                        autoSave();
                        
                        document.getElementById('modal-evolucao').style.display = 'none';
                        alert("Pe√ßa restaurada! Agora voc√™ pode continuar editando.");
                    };
                    list.appendChild(d);
                });
            } else {
                list.innerHTML = "<div style='text-align:center; padding:40px; color:#94a3b8;'>O museu est√° vazio. <br><br> Escreva sua pe√ßa e clique em üíæ para come√ßar sua cole√ß√£o de treinos!</div>";
            }
        } catch (e) {
            list.innerHTML = "Erro ao carregar arquivos.";
        }
    }
</script>
