<script type="module">
    // Importando a inteligência dos arquivos separados
    import { RadarElite } from './modulo-radar.js';
    import { BANCO_ESPELHOS } from './banco-espelhos.js';
    import { ESTRUTURAS } from './estruturas.js';

    // Variável para saber qual exame está selecionado (padrão 44)
    let activeEx = localStorage.getItem('activeEx') || "44";

    // 1. GERAR A FOLHA (Roda ao abrir)
    const container = document.getElementById('folha-total');
    if (container) {
        for(let i=1; i<=180; i++) {
            const row = document.createElement('div');
            row.className = 'linha-wrapper';
            row.innerHTML = `<div class="linha-num">${i}</div><input class="linha-folha" id="L${i}" spellcheck="false" maxlength="85">`;
            container.appendChild(row);
        }
    }

    // 2. TORNAR OS BOTÕES ATIVOS (Conectando ao HTML)
    
    // Botão do Martelo (Gavel) - Aciona o Radar para Espelhos/Questões
    window.acionarRadar = () => {
        const dna = BANCO_ESPELHOS[activeEx] || "";
        const analise = RadarElite.analisarSetor(dna);
        const linhas = RadarElite.formatarParaFolha(dna);

        linhas.forEach((txt, i) => {
            const el = document.getElementById(`L${analise.linha + i}`);
            if(el) el.value = txt;
        });
        document.getElementById('radar-status').innerHTML = `RADAR<br>${analise.nome}`;
        window.irPara(analise.linha);
    };

    // Botão do Pergaminho (Scroll) - Injeta a Peça
    window.injetarEstrutura = () => {
        const peca = ESTRUTURAS[activeEx] || ESTRUTURAS["PADRAO"] || "";
        const linhas = RadarElite.formatarParaFolha(peca);
        linhas.forEach((t, i) => { 
            const el = document.getElementById(`L${1 + i}`);
            if(el) el.value = t; 
        });
        document.getElementById('radar-status').innerHTML = `RADAR<br>ESTRUTURA`;
        window.irPara(1);
    };

    // Botão do Alvo (Bullseye)
    window.abrirExames = () => {
        const content = document.getElementById('modal-content');
        content.innerHTML = "<h3>SELECIONE O EXAME</h3>";
        Object.keys(BANCO_ESPELHOS).forEach(ex => {
            const div = document.createElement('div');
            div.style = "padding:12px; border:1px solid #ddd; margin-top:8px; cursor:pointer; font-weight:bold; background:#f8fafc; border-radius:8px";
            div.innerText = `Exame ${ex}`;
            div.onclick = () => { 
                activeEx = ex; 
                localStorage.setItem('activeEx', ex); 
                window.fechar(); 
                window.acionarRadar(); 
            };
            content.appendChild(div);
        });
        document.getElementById('modal-box').style.display = 'flex';
    };

    // Funções de Navegação e PDFs
    window.irPara = (n) => {
        const el = document.getElementById(`L${n}`);
        if(el) { el.scrollIntoView({behavior:'smooth', block:'center'}); el.focus(); }
    };
    
    window.fechar = () => document.getElementById('modal-box').style.display = 'none';
    
    window.limpar = () => { 
        if(confirm("Limpar toda a folha?")) {
            document.querySelectorAll('.linha-folha').forEach(i => i.value = "");
        }
    };

    window.pdf = (tipo) => alert(`Abrindo arquivo ${tipo.toUpperCase()} do Exame ${activeEx}`);
    window.salvar = () => alert("Progresso salvo localmente!");
    window.mentoria = () => alert("Chamando Mentoria...");

</script>
