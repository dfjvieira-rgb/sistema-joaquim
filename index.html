<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA JOAQUIM | ARYANNA MASTER</title>
    <link rel="stylesheet" href="estilos.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>

<header>
    <div class="brand">ARYANNA MASTER 2026</div>
    <div class="timer" id="cronometro">05:00:00</div>
    <div class="top-nav">
        <select id="exam-select">
            <option value="44">RO - EXAME 44</option>
            <option value="43">RO - EXAME 43</option>
            <option value="42">RO - EXAME 42</option>
            <option value="41">RO - EXAME 41</option>
            <option value="40">RO - EXAME 40</option>
            <option value="35">RO - EXAME 35</option>
        </select>
        <button class="btn-action btn-save" id="btn-salvar">SALVAR</button>
        <button class="btn-action btn-nc" id="btn-add-nc">+ POST-IT</button>
    </div>
</header>

<main>
    <section id="pdf-container">
        <div class="pdf-toolbar">
            <button id="prev-page" class="btn-util">‚óÄ</button>
            <span>P√ÅG: <span id="page-num">1</span> / <span id="page-count">0</span></span>
            <button id="next-page" class="btn-util">‚ñ∂</button>
            <button onclick="window.location.href='mentoria.html'" class="btn-util">MUSEU</button>
        </div>
        <canvas id="pdf-canvas"></canvas>
    </section>

    <section id="section-folha">
        <div class="folha-identificacao">CADERNO DE RESPOSTAS - OAB 2¬™ FASE | PE√áA PROFISSIONAL</div>
        <div id="container-postits"></div>
        <textarea id="texto-final" spellcheck="false" placeholder="Inicie sua pe√ßa aqui..."></textarea>
    </section>
</main>

<footer>
    <button class="btn-footer" data-tipo="questoes">‚ùì QUEST√ïES</button>
    <button class="btn-footer" data-tipo="espelho">üéØ ESPELHO</button>
    <button class="btn-footer" data-tipo="prazos">üìÖ PRAZOS</button>
    <button class="btn-footer" data-tipo="vade">üìö VADE MECUM</button>
</footer>

<div id="modal-container" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 id="modal-titulo">T√≠tulo</h3>
        <div id="modal-body"></div>
        <button onclick="document.getElementById('modal-container').style.display='none'" class="btn-close">FECHAR</button>
    </div>
</div>

<script type="module">
    import { PDFEngine } from './pdf-engine.js';
    import { UI } from './ui-components.js';
    import { NaoConfunda } from './nao-confunda.js';
    import { ESTRUTURAS } from './estruturas.js';
    import { BANCO_ESPELHOS } from './banco-espelhos.js';
    import { CalculadoraPrazos } from './calculadora.js';
    import { db } from './firebase-config.js';
    import { ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const App = {
        exame: "44",
        
        async init() {
            this.setupEvents();
            await this.carregarTudo();
            console.log("Sistema Sincronizado com Intelig√™ncias.");
        },

        setupEvents() {
            document.getElementById('exam-select').onchange = (e) => {
                this.exame = e.target.value;
                this.carregarTudo();
            };

            document.getElementById('btn-salvar').onclick = () => {
                const txt = document.getElementById('texto-final').value;
                set(ref(db, `v3_treino/exame_${this.exame}`), txt).then(() => alert("üíæ Salvo no Firebase!"));
            };

            document.getElementById('btn-add-nc').onclick = () => UI.abrirModalNC(this.exame);
            document.getElementById('prev-page').onclick = () => PDFEngine.changePage(-1);
            document.getElementById('next-page').onclick = () => PDFEngine.changePage(1);

            // Botoes do Footer
            document.querySelectorAll('.btn-footer').forEach(btn => {
                btn.onclick = () => this.abrirModal(btn.dataset.tipo);
            });
        },

        async carregarTudo() {
            // PDF
            try {
                const resp = await fetch(`./ro${this.exame}.pdf`);
                const buf = await resp.arrayBuffer();
                await PDFEngine.init(buf);
            } catch (e) { console.error("Falha ao carregar enunciado PDF."); }

            // Firebase + Estrutura Aryanna
            onValue(ref(db, `v3_treino/exame_${this.exame}`), (snap) => {
                const area = document.getElementById('texto-final');
                if (snap.exists()) area.value = snap.val();
                else area.value = ESTRUTURAS[this.exame]?.esqueleto || ESTRUTURAS["PADRAO"].esqueleto;
            });

            // Post-its
            NaoConfunda.renderizar(this.exame, 'container-postits');
        },

        abrirModal(tipo) {
            const modal = document.getElementById('modal-container');
            const titulo = document.getElementById('modal-titulo');
            const body = document.getElementById('modal-body');
            modal.style.display = 'flex';

            if (tipo === 'espelho') {
                titulo.innerText = `üéØ ESPELHO DE CORRE√á√ÉO - EXAME ${this.exame}`;
                const dados = BANCO_ESPELHOS[this.exame] || ["Espelho n√£o localizado."];
                body.innerHTML = `<ul>${dados.map(i => `<li>${i}</li>`).join('')}</ul>`;
            } else if (tipo === 'prazos') {
                titulo.innerText = "üìÖ CALCULADORA DE PRAZOS (CLT)";
                body.innerHTML = CalculadoraPrazos.exibirPainel();
            } else if (tipo === 'questoes') {
                titulo.innerText = "‚ùì QUEST√ïES DISSERTATIVAS";
                const q = ESTRUTURAS[this.exame]?.questoes || ["Sem quest√µes cadastradas."];
                body.innerHTML = q.map(item => `<p style='margin-bottom:15px; border-bottom:1px solid #eee'>${item}</p>`).join('');
            } else if (tipo === 'vade') {
                titulo.innerText = "üìö VADE MECUM DIGITAL";
                body.innerHTML = `<iframe src="vade.pdf" style="width:100%; height:400px;"></iframe>`;
            }
        }
    };

    App.init();
</script>
</body>
</html>
