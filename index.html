<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA JOAQUIM - MENTORIA V4.5</title>
    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #3b82f6; 
            --bg: #f1f5f9; 
            --sidebar-bg: #1e293b; 
            --guia-bg: #f0fdf4; 
            --law-green: #059669; 
            --tst-blue: #2563eb; 
            --cf-purple: #9333ea;
            --paper: #ffffff;
        }
        
        body { font-family: 'Inter', 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #1e293b; line-height: 1.6; }
        
        header { 
            background: var(--primary); color: white; padding: 10px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--accent);
        }
        .timer-box { background: #334155; padding: 5px 15px; border-radius: 20px; font-family: monospace; font-size: 1.1rem; color: #fbbf24; border: 1px solid #475569; }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        #main-app { display: none; }

        .main-layout { display: flex; flex-direction: column; min-height: 100vh; }
        @media (min-width: 768px) { .main-layout { flex-direction: row; } .sidebar { width: 260px; height: 100vh; position: sticky; top: 50px; } }
        
        .sidebar { background: var(--sidebar-bg); color: white; padding: 15px; overflow-y: auto; }
        .nav-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 6px; border: none; background: rgba(255,255,255,0.05); color: #cbd5e1; cursor: pointer; border-radius: 8px; font-size: 0.8rem; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); }
        .nav-btn.active { background: var(--accent); color: white; font-weight: bold; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        .content-area { padding: 20px; flex-grow: 1; max-width: 1000px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        #joaquim { 
            background: var(--paper); padding: 40px; border-radius: 4px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); min-height: 80vh; 
            border: 1px solid #e2e8f0; position: relative;
        }

        .gabarito-panel { background: #f8fafc; border: 1px solid #cbd5e1; padding: 15px; border-radius: 12px; margin-bottom: 25px; }
        .gab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .gab-btn { background: #64748b; color: white; border: none; padding: 10px; border-radius: 6px; font-weight: bold; font-size: 0.75rem; cursor: pointer; }
        
        .guia-btn { width: 100%; background: var(--law-green); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 800; cursor: pointer; margin-top: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .gab-content, .guia-content { display: none; margin-top: 15px; padding: 20px; background: white; border-radius: 8px; border-left: 5px solid var(--accent); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); font-family: 'Georgia', serif; }
        
        .planalto-tools { margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1; }
        .btn-planalto { color: white; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.7rem; margin: 3px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        #texto-final { 
            outline: none; min-height: 500px; white-space: pre-wrap; 
            margin-top: 30px; border-top: 1px solid #e2e8f0; padding-top: 30px; 
            font-family: 'Times New Roman', serif; font-size: 1.2rem; color: #1e293b;
            line-height: 1.8;
        }
        
        .stats-bar { display: flex; gap: 20px; font-size: 0.8rem; color: #64748b; margin-top: 10px; font-weight: 600; border-top: 1px solid #f1f5f9; padding-top: 10px; }
        
        .copy-btn { width: 100%; margin-bottom: 20px; background: var(--accent); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .copy-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>

<div id="login-screen">
    <button onclick="liberar()" style="padding:20px 50px; cursor:pointer; font-weight:bold; border-radius:50px; border:none; background:var(--accent); color:white; font-size: 1.3rem; box-shadow: 0 10px 20px rgba(0,0,0,0.3);">INICIAR SIMULADO</button>
</div>

<div id="main-app">
    <header>
        <div>JOAQUIM <span style="font-weight:200; opacity:0.7;">| 2¬™ FASE OAB</span></div>
        <div class="timer-box" id="cronometro">00:00:00</div>
    </header>
    
    <div class="main-layout">
        <nav class="sidebar" id="menuLateral"></nav>
        <main class="content-area">
            <div id="joaquim"></div>
        </main>
    </div>
</div>

<script src="gabaritos.js"></script>

<script>
    const nomesPecas = { rt: "01. Reclama√ß√£o Trabalhista", consigna: "02. Consigna√ß√£o em Pagamento", inquerito: "03. Inqu√©rito Falta Grave", cont: "04. Contesta√ß√£o", ed: "05. Embargos de Declara√ß√£o", replica: "06. R√©plica", ro: "07. Recurso Ordin√°rio", rade: "08. Recurso Adesivo", ai: "09. Agravo de Instrumento", rr: "10. Recurso de Revista", emb_tst: "11. Embargos ao TST", re_stf: "12. Recurso Extraordin√°rio", emb_exec: "13. Embargos √† Execu√ß√£o", epe: "14. Exce√ß√£o de Pr√©-Executividade", ap: "15. Agravo de Peti√ß√£o", emb_terc: "16. Embargos de Terceiro", ms: "17. Mandado de Seguran√ßa", ar: "18. A√ß√£o Rescis√≥ria" };
    
    let pecaAtiva = 'rt';
    let segundos = 0;

    function liberar() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        montarMenu();
        loadPeca('rt');
        setInterval(atualizarCronometro, 1000);
    }

    function atualizarCronometro() {
        segundos++;
        const h = Math.floor(segundos / 3600).toString().padStart(2, '0');
        const m = Math.floor((segundos % 3600) / 60).toString().padStart(2, '0');
        const s = (segundos % 60).toString().padStart(2, '0');
        document.getElementById('cronometro').innerText = `${h}:${m}:${s}`;
    }

    function montarMenu() {
        document.getElementById('menuLateral').innerHTML = Object.keys(nomesPecas).map(k => `<button class="nav-btn" id="btn_${k}" onclick="loadPeca('${k}')">${nomesPecas[k]}</button>`).join('');
    }

    function linkDirecionado(termo) {
        const t = termo.trim().toUpperCase();
        let query = "";
        // Limpeza b√°sica para evitar erro de busca
        const termoLimpo = termo.replace(/[^\w\s-]/g, '');

        if (t.includes("S√öMULA") || t.includes("SUMULA") || t.includes("OJ")) {
            query = `site:tst.jus.br jurisprudencia ${termo}`;
        } else if (t.includes("CF") || t.includes("CONSTITUI√á√ÉO")) {
            query = `site:planalto.gov.br "Constituicao Federal" ${termoLimpo}`;
        } else if (t.includes("CPC")) {
            query = `site:planalto.gov.br "Lei 13105" ${termoLimpo}`;
        } else {
            // Foco na CLT para Artigos
            query = `site:planalto.gov.br "Decreto-Lei 5452" compilado ${termoLimpo}`;
        }
        window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
    }

    function rastrearFundamentos() {
        const txtPeca = document.getElementById('texto-final')?.innerText || "";
        const txtGuia = document.getElementById('view_' + pecaAtiva)?.innerText || "";
        const total = txtPeca + " " + txtGuia;

        // Atualiza Contador de Palavras
        const palavras = txtPeca.trim().split(/\s+/).filter(w => w.length > 0).length;
        document.getElementById('word-count').innerText = palavras + ' palavras';

        // Regex para capturar fundamentos variados
        const regex = /(Art\.?|Artigo|S√∫mula|Sumula|OJ|CF|CPC|Constitui√ß√£o)\s?\d+([-]?[A-Z0-9])?/gi;
        const matches = total.match(regex) || [];
        const uniqueMatches = [...new Set(matches.map(m => m.trim()))];

        const container = document.getElementById('container-rastreio');
        if (!container) return;

        container.innerHTML = uniqueMatches.length ? uniqueMatches.map(m => {
            const mUp = m.toUpperCase();
            let cor = 'var(--law-green)';
            if (mUp.includes("S√öMULA") || mUp.includes("SUMULA") || mUp.includes("OJ")) cor = 'var(--tst-blue)';
            if (mUp.includes("CF") || mUp.includes("CONSTITUI√á√ÉO")) cor = 'var(--cf-purple)';
            return `<button class="btn-planalto" style="background:${cor}" onclick="linkDirecionado('${m}')">üîé ${m}</button>`;
        }).join('') : '<span style="color:#94a3b8; font-size:0.7rem;">Nenhum fundamento detectado no rascunho...</span>';
    }

    function loadPeca(key) {
        pecaAtiva = key;
        const db = window.dbGabaritosExternos || {};
        const dadosPeca = db[key] || {};
        let botoesGab = '';

        Object.keys(dadosPeca).forEach(n => {
            if(!isNaN(n)) botoesGab += `<button class="gab-btn" onclick="toggleVis('${key}_${n}')">üìñ Gabarito ${n}</button>`;
        });

        const guiaTexto = localStorage.getItem('guia_' + key) || dadosPeca.guia || "Escreva seus quesitos de fundamenta√ß√£o aqui...";

        document.getElementById('joaquim').innerHTML = `
            <button class="copy-btn" onclick="copyText()">FINALIZAR E COPIAR PE√áA</button>
            
            <div class="gabarito-panel">
                <div class="gab-grid">${botoesGab}</div>
                <button class="guia-btn" onclick="toggleVis('${key}_guia')">üí° FUNDAMENTA√á√ÉO E GUIA</button>
                <div id="${key}_guia" class="guia-content">
                    <div id="view_${key}" style="white-space:pre-wrap;">${guiaTexto}</div>
                    <div class="planalto-tools">
                        <strong style="font-size:10px; color:#64748b; display:block; margin-bottom:5px;">RASTREIO DE FUNDAMENTOS (PE√áA + GUIA):</strong>
                        <div id="container-rastreio"></div>
                    </div>
                    <button onclick="showEditor('${key}')" style="margin-top:10px; cursor:pointer; font-size:11px; color:blue; background:none; border:none; text-decoration:underline;">üìù Editar Notas</button>
                    <div id="ed_${key}" style="display:none; margin-top:10px;">
                        <textarea id="area_${key}" class="edit-guia-area" style="width:100%; height:100px;">${guiaTexto}</textarea>
                        <button onclick="saveGuia('${key}')" style="width:100%; padding:10px; background:var(--law-green); color:white; border:none; border-radius:5px; cursor:pointer; margin-top:5px;">SALVAR</button>
                    </div>
                </div>
                ${Object.keys(dadosPeca).filter(n => !isNaN(n)).map(n => `<div id="${key}_${n}" class="gab-content"><strong>GABARITO ${n}:</strong>\n\n${dadosPeca[n]}</div>`).join('')}
            </div>

            <div id="texto-final" contenteditable="true" oninput="rastrearFundamentos()" spellcheck="false">ID: 936045\n\n(Comece sua pe√ßa aqui...)</div>
            
            <div class="stats-bar">
                <span id="word-count">0 palavras</span>
                <span>Simulado em tempo real</span>
            </div>
        `;

        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn_' + key)?.classList.add('active');
        rastrearFundamentos();
    }

    function toggleVis(id) {
        const el = document.getElementById(id);
        if(!el) return;
        const isVis = el.style.display === 'block';
        document.querySelectorAll('.gab-content, .guia-content').forEach(d => d.style.display = 'none');
        el.style.display = isVis ? 'none' : 'block';
        rastrearFundamentos();
    }

    function showEditor(k) {
        document.getElementById('ed_'+k).style.display = 'block';
        document.getElementById('view_'+k).style.display = 'none';
    }

    function saveGuia(k) {
        localStorage.setItem('guia_'+k, document.getElementById('area_'+k).value);
        loadPeca(k);
    }

    function copyText() {
        const el = document.getElementById('texto-final');
        const range = document.createRange();
        range.selectNode(el);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        alert("Copiado com sucesso!");
        window.getSelection().removeAllRanges();
    }
</script>
</body>
</html>
