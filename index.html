<script>
    // ... (mantenha as vari√°veis de topo: exAtual, pdfDoc, etc)

    // TORNAR A FUN√á√ÉO GLOBAL PARA O BOT√ÉO FUNCIONAR
    window.gerarCaderno = function(corpoPeca) {
        const divisor = "\n\n" + "-".repeat(30) + " RESPOSTA OAB " + "-".repeat(30) + "\n";
        
        // Montagem do Caderno Real FGV
        const template = corpoPeca + 
                         "\n\n\n" + divisor + "QUEST√ÉO 1\na)\nb)\n" + 
                         divisor + "QUEST√ÉO 2\na)\nb)\n" + 
                         divisor + "QUEST√ÉO 3\na)\nb)\n" + 
                         divisor + "QUEST√ÉO 4\na)\nb)";
        
        const textArea = document.getElementById('texto-final');
        textArea.value = template;
        
        // Garante o salvamento imediato no Firebase
        autoSave();
        
        // Fecha o modal e sobe para o topo da folha
        document.getElementById('modal-pecas').style.display = 'none';
        document.getElementById('scroll-area').scrollTop = 0;
    };

    window.abrirPecas = function() {
        const container = document.getElementById('lista-pecas-contextual');
        const modal = document.getElementById('modal-pecas');
        document.getElementById('titulo-modal-pecas').innerText = `‚öñÔ∏è ESTRUTURAS EXAME ${exAtual}`;
        
        // Busca a pe√ßa do banco local ou usa padr√£o
        const pecaInfo = bancoPecas[exAtual] || { 
            titulo: "Peti√ß√£o Inicial (RT)", 
            corpo: "AO DOUTO JU√çZO DA ... VARA DO TRABALHO DE ...\n\nRECLAMANTE: ...\nRECLAMADO: ...\n\nRECLAMA√á√ÉO TRABALHISTA..." 
        };
        
        // O bot√£o agora chama window.gerarCaderno com crases para lidar com quebras de linha
        container.innerHTML = `
            <button onclick="window.gerarCaderno(\`${pecaInfo.corpo}\`)" style="width:100%; padding:20px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:800; cursor:pointer; font-size:1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                üìù GERAR CADERNO COMPLETO:<br>
                <span style="font-weight:400; font-size:0.8rem;">${pecaInfo.titulo}</span>
            </button>
        `;
        modal.style.display = 'flex';
    };

    // ... (resto do script de PDF e Firebase)
</script>
