<script type="module">
    import { db } from './firebase-config.js';
    import { ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { BANCO_ESPELHOS } from './banco-espelhos.js';
    import { pecas } from './estruturas.js';
    import { RadarElite } from './modulo-radar.js';

    let activeEx = localStorage.getItem('activeEx') || "44";
    let ultimaLinhaFocada = 1;
    let mentoriaJanelaRef = null;
    const LIMITE_LINHA = 85;

    // --- FUNÃ‡ÃƒO DE SCANNER (RADAR) ---
    const escaneamentoElite = () => {
        const dna = (BANCO_ESPELHOS[activeEx] || "");
        const analise = RadarElite.analisarGabarito(dna);
        
        const sidebarStatus = document.getElementById('radar-status');
        const boxSidebar = document.getElementById('radar-container');
        const topoFolha = document.getElementById('identificador-peca');

        if (analise.peca) {
            sidebarStatus.innerHTML = `<span style="color:${analise.peca.cor}">RADAR</span><br>${analise.peca.id}`;
            boxSidebar.style.borderColor = analise.peca.cor;
            boxSidebar.classList.remove('radar-blink');
            topoFolha.innerText = analise.peca.display;
            topoFolha.style.color = analise.peca.cor;
            topoFolha.style.borderBottomColor = analise.peca.cor;
        } else if (analise.questao) {
            sidebarStatus.innerHTML = `<span style="color:var(--gold)">RADAR</span><br>${analise.questao.id}`;
            boxSidebar.style.borderColor = "var(--gold)";
            boxSidebar.classList.remove('radar-blink');
            topoFolha.innerText = `RESPOSTA: ${analise.questao.id}`;
            topoFolha.style.color = "var(--gold)";
            topoFolha.style.borderBottomColor = "var(--gold)";
        } else {
            sidebarStatus.innerHTML = `<span>RADAR</span><br><span class="radar-blink">BUSCANDO...</span>`;
            boxSidebar.style.borderColor = "var(--gold)";
            topoFolha.innerText = "CADERNO DE RESPOSTAS";
            topoFolha.style.color = "#64748b";
            topoFolha.style.borderBottomColor = "var(--line-color)";
        }
    };

    // --- INJETAR JUSTIÃ‡A (GABARITO -> FOLHA) ---
    window.injetarJustica = () => {
        const dna = BANCO_ESPELHOS[activeEx] || "";
        const linhasFormatadas = RadarElite.formatarParaInjecao(dna, LIMITE_LINHA);

        if(linhasFormatadas.length > 0) {
            linhasFormatadas.forEach((texto, i) => {
                const el = document.getElementById(`L${ultimaLinhaFocada + i}`);
                if(el) el.value = texto;
            });
            salvarManual();
            alert("âš–ï¸ JUSTIÃ‡A INJETADA COM SUCESSO!");
        }
    };

    // --- MONTAGEM DA FOLHA ---
    const montarFolha = () => {
        const container = document.getElementById('folha-total');
        container.innerHTML = "";
        for(let i=1; i<=180; i++) {
            if(i === 1 || i === 51) {
                const h = document.createElement('div');
                h.style.cssText = "background:#1e293b; color:#fbbf24; padding:8px; text-align:center; font-size:0.7rem; font-weight:bold;";
                h.innerText = i === 1 ? 'CADERNO DE RESPOSTAS - PEÃ‡A' : 'CADERNO DE RESPOSTAS - QUESTÃ•ES';
                container.appendChild(h);
            }
            const row = document.createElement('div');
            row.className = 'linha-wrapper';
            const input = document.createElement('input');
            input.className = 'linha-folha';
            input.id = `L${i}`;
            input.setAttribute('spellcheck', 'false');
            input.setAttribute('maxlength', LIMITE_LINHA);

            input.oninput = () => { if (input.value.length >= LIMITE_LINHA) document.getElementById(`L${i + 1}`)?.focus(); };
            input.onkeydown = (e) => { 
                if (e.key === "Enter") { e.preventDefault(); document.getElementById(`L${i + 1}`)?.focus(); } 
                if (e.key === "Backspace" && input.value.length === 0) document.getElementById(`L${i - 1}`)?.focus();
            };
            input.onfocus = () => { ultimaLinhaFocada = i; };
            row.innerHTML = `<div class="linha-num">${i}</div>`;
            row.appendChild(input);
            container.appendChild(row);
        }
        carregarDados();
    };

    const carregarDados = () => {
        onValue(ref(db, 'estudos/' + activeEx), (snap) => {
            const data = snap.val();
            if (data && data.linhas) {
                data.linhas.forEach((txt, idx) => {
                    const el = document.getElementById(`L${idx + 1}`);
                    if (el) el.value = txt;
                });
            }
            escaneamentoElite();
        }, { onlyOnce: true });
    };

    // --- MENTORIA E HISTÃ“RICO ---
    window.abrirMentoria = () => {
        const width = 550, height = window.screen.availHeight, left = window.screen.availWidth - width;
        const config = `width=${width},height=${height},top=0,left=${left},resizable=yes,scrollbars=yes`;
        mentoriaJanelaRef = window.open('mentoria.html?mode=consultor', 'ConsultorElite', config);
        if (mentoriaJanelaRef) mentoriaJanelaRef.focus();
    };

    window.concluirEEnviarAoRobo = () => {
        if(!confirm(`Deseja enviar o Exame ${activeEx} para o Cofre do RobÃ´?`)) return;
        push(ref(db, 'mentoria/historico'), {
            exame: activeEx,
            data: new Date().toLocaleDateString('pt-BR') + ", " + new Date().toLocaleTimeString('pt-BR'),
            ts: Date.now()
        }).then(() => {
            alert("ðŸš€ EXAME ARQUIVADO NO COFRE!");
            abrirMentoria();
        }).catch(err => alert("Erro ao enviar: " + err));
    };

    // --- MODAIS E UTILITÃRIOS ---
    window.abrirModalExames = () => {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<h2 style="text-align:center; margin-bottom:15px;">EXAMES</h2>`;
        const grid = document.createElement('div'); grid.style.display="grid"; grid.style.gridTemplateColumns="1fr 1fr"; grid.style.gap="10px";
        for(let i=44; i>=35; i--) {
            const b = document.createElement('div'); b.className='opt-btn'; b.innerText=`Exame ${i}`;
            b.onclick = () => { activeEx = i.toString(); localStorage.setItem('activeEx', activeEx); montarFolha(); fecharModal(); };
            grid.appendChild(b);
        }
        content.appendChild(grid);
        document.getElementById('universal-modal').style.display='flex';
    };

    window.salvarManual = () => {
        const dados = Array.from(document.querySelectorAll('.linha-folha')).map(i => i.value);
        set(ref(db, 'estudos/' + activeEx), { linhas: dados, ts: Date.now() }).then(() => console.log("â˜ï¸ SINCRONIZADO!"));
    };

    window.abrirModalPecas = () => {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<h2 style="text-align:center; margin-bottom:15px;">ESTRUTURAS</h2>`;
        Object.keys(pecas).forEach(k => {
            const b = document.createElement('div'); b.className='opt-btn'; b.innerText=k;
            b.onclick = () => {
                pecas[k].split('\n').forEach((t, i) => {
                    const el = document.getElementById(`L${ultimaLinhaFocada + i}`);
                    if(el) el.value = t.substring(0, LIMITE_LINHA);
                });
                fecharModal(); salvarManual();
            };
            content.appendChild(b);
        });
        document.getElementById('universal-modal').style.display='flex';
    };

    window.abrirSplitPdf = (t) => {
        document.getElementById('pdf-frame').src = t === 'v' ? 'vade.pdf' : `ro${activeEx}${t === 'g' ? '-gabarito' : ''}.pdf`;
        document.getElementById('pdf-split-view').classList.add('active');
    };

    window.fecharSplitPdf = () => { document.getElementById('pdf-split-view').classList.remove('active'); document.getElementById('pdf-frame').src = ""; };
    window.fecharModal = () => document.getElementById('universal-modal').style.display='none';
    window.irPara = (n) => document.getElementById(`L${n}`)?.scrollIntoView({behavior:'smooth', block:'center'});
    window.resetarFolha = () => { if(confirm("Limpar folha?")) document.querySelectorAll('.linha-folha').forEach(i => i.value=""); };

    window.onload = () => montarFolha();

    Object.assign(window, { 
        abrirModalExames, abrirModalPecas, fecharModal, fecharSplitPdf, 
        abrirSplitPdf, salvarManual, injetarJustica, irPara, 
        resetarFolha, abrirMentoria, concluirEEnviarAoRobo 
    });
</script>
