<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ARYANNA 2026 | COFRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #fbbf24; --primary: #1d4ed8; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .panel { background: #fff; border-radius: 12px; border: 2px solid #94a3b8; margin-bottom: 15px; }
        .panel-header { padding: 12px; background: #f8fafc; border-bottom: 2px solid #94a3b8; font-weight: 800; text-align: center; font-size: 0.8rem; }
        .card-pdf { 
            border-left: 8px solid var(--gold); display: flex; justify-content: space-between; 
            align-items: center; background: #fff; padding: 12px; margin: 10px;
            border-radius: 8px; border: 1px solid #cbd5e1; border-left-width: 8px;
        }
        .btn-revisar { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .status-hoje { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 800; margin-bottom: 5px; display: inline-block; }
        
        /* Box do Robô / Análise */
        #analise-box { display: none; background: #1e293b; color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 8px solid #3b82f6; }
    </style>
</head>
<body>

<header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <button onclick="window.close()" style="border:2px solid #000; background:white; font-weight:800; padding:5px 10px; cursor:pointer;">FECHAR</button>
    <div style="font-weight:800;">PEÇAS NO COFRE</div>
</header>

<div id="analise-box">
    <div style="font-weight: 900; color: var(--gold); margin-bottom: 5px; font-size: 0.7rem;">ANALISANDO...</div>
    <div id="analise-texto" style="font-size: 0.9rem;"></div>
</div>

<div class="panel">
    <div class="panel-header">HISTÓRICO DE ENVIOS</div>
    <div id="feed-historico" style="padding: 5px;">
        <p style="text-align:center; padding:20px; color:#64748b;">Sincronizando com o satélite...</p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { 
        apiKey: "AIzaSyAmigODFK8R9c0-fWtagdxLWu9xkODfKYQ", 
        authDomain: "masteroab-db5e1.firebaseapp.com", 
        projectId: "masteroab-db5e1", 
        databaseURL: "https://masteroab-db5e1-default-rtdb.firebaseio.com" 
    };

    const app = initializeApp(config);
    const db = getDatabase(app);

    // ESCUTA EM TEMPO REAL (onValue garante que atualiza ao enviar na Home)
    const historicoRef = ref(db, 'mentoria/historico');
    
    onValue(historicoRef, (snapshot) => {
        const container = document.getElementById('feed-historico');
        container.innerHTML = "";
        const dados = snapshot.val();

        if (dados) {
            // Converte e ordena pelos mais recentes (ts)
            const listaOrdenada = Object.keys(dados)
                .map(id => ({ id, ...dados[id] }))
                .sort((a, b) => (b.ts || 0) - (a.ts || 0));

            listaOrdenada.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card-pdf';
                card.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-size:0.6rem; color:#64748b; font-weight:bold;">EXAME OAB</span>
                        <b style="font-size:1.1rem; color:#1e293b;">EXAME ${item.exame || '??'}</b>
                        <span style="font-size:0.7rem; color:#94a3b8;">${item.data || 'Sem data'}</span>
                    </div>
                    <button class="btn-revisar" onclick="analisarPeca('${item.exame}')">ANALISAR</button>
                `;
                container.appendChild(card);
            });
        } else {
            container.innerHTML = "<p style='text-align:center; color:#94a3b8; padding:20px;'>Cofre vazio.</p>";
        }
    });

    // FUNÇÃO DO ROBÔ: Traz os dados reais da peça e analisa
    window.analisarPeca = async (ex) => {
        const box = document.getElementById('analise-box');
        const texto = document.getElementById('analise-texto');
        
        box.style.display = 'block';
        texto.innerHTML = "O Robô está lendo suas linhas...";

        // Busca o conteúdo real que você escreveu no index.html
        const snap = await get(ref(db, `estudos/${ex}`));
        const dados = snap.val();

        if (dados && dados.linhas) {
            const preenchidas = dados.linhas.filter(l => l.trim() !== "").length;
            texto.innerHTML = `
                <b>Análise Concluída:</b> O Exame ${ex} possui ${preenchidas} linhas preenchidas.<br><br>
                <button onclick="revisar('${ex}')" style="background:var(--gold); border:none; padding:5px 10px; border-radius:4px; font-weight:bold; cursor:pointer;">ABRIR NO CADERNO</button>
            `;
        } else {
            texto.innerHTML = "Não encontrei texto escrito para este exame.";
        }
    };

    window.revisar = (ex) => {
        if(window.opener) {
            window.opener.localStorage.setItem('activeEx', ex);
            window.opener.location.reload();
            window.close();
        } else {
            alert("Abra pelo Cockpit principal.");
        }
    };

    Object.assign(window, { analisarPeca, revisar });
</script>
</body>
</html>
