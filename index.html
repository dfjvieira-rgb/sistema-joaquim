<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aryanna Master Pro 2026 - Edi√ß√£o Vade Mecum Otimizada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        #sidebar { width: 260px; background: var(--primary); color: white; padding: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 10; }
        #main-content { flex: 1; display: flex; flex-direction: column; padding: 15px; gap: 10px; background: #e8ecef; }
        #pdf-panel { flex: 1.2; background: #525659; display: flex; flex-direction: column; border-left: 2px solid #333; position: relative; }
        
        /* Estilo Editor */
        #editor { flex: 1; padding: 20px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; line-height: 1.6; resize: none; font-family: 'Times New Roman', serif; }

        /* Controles PDF */
        #pdf-controls { background: #333; color: white; padding: 8px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .nav-btn { background: #444; border: 1px solid #666; color: white; padding: 4px 10px; cursor: pointer; border-radius: 3px; }
        .nav-btn:hover { background: var(--accent); }
        #page-num { width: 45px; text-align: center; }

        /* Container do PDF com Camada de Texto */
        #pdf-viewer { flex: 1; overflow: auto; position: relative; background: #525659; display: flex; justify-content: center; }
        .pdf-page-container { position: relative; margin: 10px auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); background: white; }
        .textLayer { opacity: 0.2; } /* Camada que permite selecionar texto */

        /* Espelho e Post-its */
        #espelho-container { width: 300px; background: white; border-left: 1px solid #ddd; padding: 15px; overflow-y: auto; font-size: 12px; }
        .post-it { background: #fff9c4; padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 4px solid #fbc02d; color: #333; }
        .btn-peca { background: #34495e; border: none; color: white; padding: 8px; text-align: left; cursor: pointer; border-radius: 4px; width: 100%; font-size: 12px; }
    </style>
</head>
<body>

    <aside id="sidebar">
        <h3>Pe√ßas Base</h3>
        <button class="btn-peca" onclick="carregarEstrutura('RT')">Reclama√ß√£o</button>
        <button class="btn-peca" onclick="carregarEstrutura('CON')">Contesta√ß√£o</button>
        <button class="btn-peca" onclick="carregarEstrutura('RO')">Recurso Ord.</button>
        <hr>
        <div id="meus-postits"></div>
        <button class="btn-peca" style="background:var(--accent)" onclick="addPostIt()">+ Novo Post-it</button>
        <hr>
        <label>Vade Mecum (PDF):</label>
        <input type="file" id="file-upload" accept="application/pdf" style="width:100%; font-size:10px;">
    </aside>

    <main id="main-content">
        <div style="display:flex; justify-content:space-between;">
            <select id="select-espelho" onchange="window.carregarEspelho(this.value)">
                <option value="">Escolher Espelho...</option>
                <option value="44">44¬∫ Exame</option>
                <option value="41">41¬∫ Exame</option>
                <option value="40">40¬∫ Exame</option>
            </select>
            <button onclick="salvarProgresso()">üíæ Salvar Tudo</button>
        </div>
        <textarea id="editor" placeholder="Redija sua pe√ßa..."></textarea>
    </main>

    <section id="pdf-panel">
        <div id="pdf-controls">
            <button class="nav-btn" onclick="changePage(-1)">‚ùÆ</button>
            <input type="number" id="page-num" value="1" min="1" onchange="goToPage(this.value)"> 
            <span>/ <span id="page-count">0</span></span>
            <button class="nav-btn" onclick="changePage(1)">‚ùØ</button>
        </div>
        <div id="pdf-viewer">
            <div id="page-wrapper" class="pdf-page-container">
                <canvas id="pdf-canvas"></canvas>
                <div id="text-layer" class="textLayer"></div>
            </div>
        </div>
    </section>

    <section id="espelho-container">
        <div id="itens-espelho"></div>
        <div id="nota-final" style="font-size:20px; font-weight:bold; color:var(--accent); text-align:center; margin-top:10px;">Nota: 0,00</div>
    </section>

    <script type="module">
        import { DATA_MASTER } from './estruturas.js';

        // Configura√ß√µes PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null, pageNum = 1, pageRendering = false;
        const scale = 1.5;

        async function renderPage(num) {
            pageRendering = true;
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale });
            
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            // Renderizar Imagem
            const renderContext = { canvasContext: context, viewport: viewport };
            await page.render(renderContext).promise;

            // Renderizar Camada de Texto (PARA COPIAR)
            const textLayerDiv = document.getElementById('text-layer');
            textLayerDiv.innerHTML = "";
            textLayerDiv.style.height = viewport.height + "px";
            textLayerDiv.style.width = viewport.width + "px";
            
            const textContent = await page.getTextContent();
            pdfjsLib.renderTextLayer({
                textContent: textContent,
                container: textLayerDiv,
                viewport: viewport,
                textDivs: []
            });

            pageRendering = false;
            document.getElementById('page-num').value = num;
        }

        window.changePage = (offset) => {
            if (!pdfDoc || pageRendering) return;
            const newPage = pageNum + offset;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                renderPage(pageNum);
            }
        };

        window.goToPage = (num) => {
            const n = parseInt(num);
            if (pdfDoc && n >= 1 && n <= pdfDoc.numPages) {
                pageNum = n;
                renderPage(pageNum);
            }
        };

        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                document.getElementById('page-count').textContent = pdfDoc.numPages;
                renderPage(1);
            }
        });

        // Fun√ß√µes de Interface
        window.carregarEstrutura = (t) => document.getElementById('editor').value = DATA_MASTER.estruturas[t];
        window.carregarEspelho = (id) => {
            document.getElementById('itens-espelho').innerHTML = DATA_MASTER.espelhos[id];
            window.calcNota();
        }
        window.calcNota = () => {
            let total = 0;
            document.querySelectorAll('#itens-espelho input:checked').forEach(i => total += parseFloat(i.value));
            document.getElementById('nota-final').innerText = `Nota: ${total.toFixed(2)}`;
        }
        window.addPostIt = () => {
            const m = prompt("Dica:");
            if(m) {
                const d = document.createElement('div'); d.className='post-it'; d.innerText=`üìå ${m}`;
                document.getElementById('meus-postits').appendChild(d);
            }
        }
        window.salvarProgresso = () => {
            localStorage.setItem('treino_texto', document.getElementById('editor').value);
            alert("Progresso salvo!");
        }
    </script>
</body>
</html>
