<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ARYANNA 2026 | COFRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #fbbf24; --primary: #1d4ed8; --bg: #f1f5f9; --tese: #7c3aed; --confunda: #dc2626; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .panel { background: #fff; border-radius: 12px; border: 2px solid #94a3b8; margin-bottom: 15px; }
        .panel-header { padding: 12px; background: #f8fafc; border-bottom: 2px solid #94a3b8; font-weight: 800; text-align: center; font-size: 0.8rem; }
        .card-pdf { 
            border-left: 8px solid var(--gold); display: flex; justify-content: space-between; 
            align-items: center; background: #fff; padding: 12px; margin: 10px;
            border-radius: 8px; border: 1px solid #cbd5e1; border-left-width: 8px;
        }
        .btn-revisar { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* Box do Robô / Análise Principal */
        #analise-box { display: none; background: #1e293b; color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 8px solid #3b82f6; }
        
        /* Novos Boxes de Inteligência integrados ao Estilo */
        .box-IA { display: none; padding: 15px; border-radius: 12px; margin-bottom: 10px; color: white; font-size: 0.9rem; border-left: 8px solid rgba(0,0,0,0.3); }
        #tese-area { background: var(--tese); }
        #confunda-area { background: var(--confunda); }
        .label-ia { font-weight: 900; font-size: 0.65rem; text-transform: uppercase; margin-bottom: 5px; opacity: 0.9; display: block; }
    </style>
</head>
<body>

<header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <button onclick="window.close()" style="border:2px solid #000; background:white; font-weight:800; padding:5px 10px; cursor:pointer;">FECHAR</button>
    <div style="font-weight:800;">PEÇAS NO COFRE</div>
</header>

<div id="analise-box">
    <span class="label-ia" style="color: var(--gold);"><i class="fas fa-robot"></i> Inteligência Artificial</span>
    <div id="analise-texto" style="font-size: 1.1rem; font-weight: 900; letter-spacing: 1px;"></div>
</div>

<div id="tese-area" class="box-IA">
    <span class="label-ia"><i class="fas fa-gavel"></i> Tese Recomendada</span>
    <div id="tese-texto"></div>
</div>

<div id="confunda-area" class="box-IA">
    <span class="label-ia"><i class="fas fa-exclamation-triangle"></i> Não Confunda</span>
    <div id="confunda-texto"></div>
</div>

<div class="panel">
    <div class="panel-header">HISTÓRICO DE ENVIOS</div>
    <div id="feed-historico" style="padding: 5px;">
        <p style="text-align:center; padding:20px; color:#64748b;">Sincronizando...</p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { 
        apiKey: "AIzaSyAmigODFK8R9c0-fWtagdxLWu9xkODfKYQ", 
        authDomain: "masteroab-db5e1.firebaseapp.com", 
        projectId: "masteroab-db5e1", 
        databaseURL: "https://masteroab-db5e1-default-rtdb.firebaseio.com" 
    };

    const app = initializeApp(config);
    const db = getDatabase(app);

    // Dicionário de Teses e Alertas
    const DATABASE_IA = {
        "AGRAVO DE PETIÇÃO": {
            tese: "Fase de Execução (Art. 897, 'a', CLT). Lembre-se de delimitar justificadamente as matérias e os valores.",
            confunda: "Agravo de Instrumento (trabalhista) serve apenas para destrancar recurso retido. O Agravo de Petição é para discutir o mérito da execução."
        },
        "RECURSO ORDINÁRIO": {
            tese: "Prazo de 8 dias (Art. 895, I, CLT). Cabível contra sentença definitiva em rito ordinário ou sumário.",
            confunda: "No processo do trabalho não existe Apelação. O recurso contra a sentença é o RO."
        },
        "CONTESTAÇÃO": {
            tese: "Defesa técnica (Art. 847, CLT). Argua preliminares (Art. 337, CPC) antes do mérito.",
            confunda: "Lembre-se: o prazo é preclusivo até a audiência. Fique atento à Reconvenção se houver pedidos contra o autor."
        },
        "RECLAMAÇÃO": {
            tese: "Petição Inicial (Art. 840, CLT). Requisitos: breve exposição dos fatos, pedido certo, determinado e com indicação de valor.",
            confunda: "Não confunda rito Sumaríssimo (até 40 salários) com rito Ordinário. No sumaríssimo, os pedidos devem ser liquidados sempre."
        }
    };

    // Escuta do histórico
    onValue(ref(db, 'mentoria/historico'), (snapshot) => {
        const container = document.getElementById('feed-historico');
        container.innerHTML = "";
        const dados = snapshot.val();
        if (dados) {
            Object.keys(dados).map(id => ({ id, ...dados[id] }))
                .sort((a, b) => b.ts - a.ts)
                .forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'card-pdf';
                    card.innerHTML = `
                        <div style="padding:10px;">
                            <b style="color:#1e293b;">OAB ${item.exame}</b><br>
                            <small style="color:#64748b;">Enviado: ${item.data}</small>
                        </div>
                        <button class="btn-revisar" onclick="analisarPeca('${item.exame}')">ANALISAR</button>
                    `;
                    container.appendChild(card);
                });
        }
    });

    // Função de Inteligência
    window.analisarPeca = async (ex) => {
        const snap = await get(ref(db, `estudos/${ex}`));
        const dados = snap.val();
        
        if (!dados || !dados.linhas) return alert("Peça sem conteúdo para analisar.");

        const textoLimpo = dados.linhas.join(" ").toUpperCase();
        let pecaSugerida = "PEÇA NÃO IDENTIFICADA";

        // Motor de Identificação
        for (let chave in DATABASE_IA) {
            if (textoLimpo.includes(chave)) pecaSugerida = chave;
        }

        // Exibição do Box Azul
        document.getElementById('analise-box').style.display = 'block';
        document.getElementById('analise-texto').innerHTML = pecaSugerida + 
        `<br><button onclick="revisar('${ex}')" style="margin-top:10px; padding:5px 10px; background:var(--gold); border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.7rem;">ABRIR CADERNO</button>`;

        // Exibição de Teses e Confunda
        if (DATABASE_IA[pecaSugerida]) {
            document.getElementById('tese-area').style.display = 'block';
            document.getElementById('tese-texto').innerText = DATABASE_IA[pecaSugerida].tese;
            document.getElementById('confunda-area').style.display = 'block';
            document.getElementById('confunda-texto').innerText = DATABASE_IA[pecaSugerida].confunda;
        } else {
            document.getElementById('tese-area').style.display = 'none';
            document.getElementById('confunda-area').style.display = 'none';
        }
    };

    window.revisar = (ex) => {
        if(window.opener) {
            window.opener.localStorage.setItem('activeEx', ex);
            window.opener.location.reload();
            window.close();
        }
    };

    Object.assign(window, { analisarPeca, revisar });
</script>
</body>
</html>
