<script type="module">
    import { initializeApp } from "https://www.gstatic.com";
    import { getDatabase, ref, push, set, onValue, remove, serverTimestamp } from "https://www.gstatic.com";

    const config = { 
        apiKey: "AIzaSyAmigODFK8R9c0-fWtagdxLWu9xkODfKYQ", 
        authDomain: "masteroab-db5e1.firebaseapp.com", 
        projectId: "masteroab-db5e1", 
        databaseURL: "https://masteroab-db5e1-default-rtdb.firebaseio.com" 
    };
    
    const app = initializeApp(config);
    const db = getDatabase(app);
    const paths = { pre: 'v13_pre', peca: 'v13_peca', nc: 'v13_nc', tese: 'v13_tese' };

    window.toggleR = (btn) => { 
        const div = btn.nextElementSibling; 
        div.style.display = (div.style.display === "block" ? "none" : "block"); 
    };

    window.salvar = (type) => {
        const id = document.getElementById(`id-${type}`).value;
        const t = document.getElementById(`${type}-t`).value;
        const c = document.getElementById(`${type}-c`).value;
        if(!t || !c) return;
        const data = { t, c, ts: serverTimestamp() };
        if(id) set(ref(db, `${paths[type]}/${id}`), data);
        else push(ref(db, paths[type]), data);
        document.getElementById(`${type}-t`).value = '';
        document.getElementById(`${type}-c`).value = '';
    };

    // --- RADAR BLACK BOX: SINCRONIZAÇÃO COM O COCKPIT (index.html) ---
    onValue(ref(db, 'estudos'), (snap) => {
        const feedBB = document.getElementById('black-box-feed');
        const voos = snap.val();
        if(!voos) { feedBB.innerHTML = "Radar limpo."; return; }
        
        feedBB.innerHTML = "";
        Object.keys(voos).sort((a,b) => b-a).forEach(exId => {
            const voo = voos[exId];
            
            // Formatação da Data do Voo
            let dataFmt = voo.ts ? new Date(voo.ts).toLocaleDateString('pt-BR') : "--/--/--";

            // Captura o texto do editor-peca do index.html
            const textoPreview = voo['editor-peca'] 
                ? voo['editor-peca'].substring(0, 80).replace(/<[^>]*>?/gm, '') + "..." 
                : "Sem conteúdo detectado...";
            
            const div = document.createElement('div');
            div.className = 'black-box-item';
            div.innerHTML = `
                <div class="bb-meta"><span>EXAME E${exId}</span><span>${dataFmt}</span></div>
                <div style="font-family:serif; font-size:0.85rem; opacity:0.9;">${textoPreview}</div>
            `;
            div.onclick = () => { location.href = 'index.html'; };
            feedBB.appendChild(div);
        });
    });

    // --- CARREGAMENTO DOS TRIPULANTES TÉCNICOS ---
    onValue(ref(db), (snap) => {
        const v = snap.val() || {};
        ['pre', 'peca', 'nc', 'tese'].forEach(type => {
            const f = document.getElementById(`feed-${type}`);
            if(!f) return;
            f.innerHTML = "";
            const obj = v[paths[type]] || {};
            Object.keys(obj).sort((a,b) => obj[b].ts - obj[a].ts).forEach(id => {
                const item = obj[id];
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<strong>${item.t}</strong><p>${item.c}</p>`;
                if(type === 'peca') {
                    card.innerHTML += `<button class="btn-reveal" onclick="window.toggleR(this)">VER GABARITO</button><div class="hidden-content">${item.c}</div>`;
                }
                f.appendChild(card);
            });
        });
    });
</script>
