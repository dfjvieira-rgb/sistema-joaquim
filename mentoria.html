<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ARYANNA 2026 | COFRE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #fbbf24; --primary: #1d4ed8; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .panel { background: #fff; border-radius: 12px; border: 2px solid #94a3b8; margin-bottom: 15px; }
        .panel-header { padding: 12px; background: #f8fafc; border-bottom: 2px solid #94a3b8; font-weight: 800; text-align: center; font-size: 0.8rem; }
        .card-pdf { 
            border-left: 8px solid var(--gold); display: flex; justify-content: space-between; 
            align-items: center; background: #fff; padding: 12px; margin: 10px;
            border-radius: 8px; border: 1px solid #cbd5e1; border-left-width: 8px;
        }
        .btn-revisar { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .status-hoje { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 800; margin-bottom: 5px; display: inline-block; }
    </style>
</head>
<body>

<header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <button onclick="window.close()" style="border:2px solid #000; background:white; font-weight:800; padding:5px 10px; cursor:pointer;">FECHAR</button>
    <div style="font-weight:800;">PEÇAS NO COFRE</div>
</header>

<div class="panel">
    <div class="panel-header">HISTÓRICO DE ENVIOS</div>
    <div id="feed-historico" style="padding: 5px;">
        <p style="text-align:center; padding:20px; color:#64748b;">Sincronizando com o satélite...</p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const config = { 
        apiKey: "AIzaSyAmigODFK8R9c0-fWtagdxLWu9xkODfKYQ", 
        authDomain: "masteroab-db5e1.firebaseapp.com", 
        projectId: "masteroab-db5e1", 
        databaseURL: "https://masteroab-db5e1-default-rtdb.firebaseio.com" 
    };

    const app = initializeApp(config);
    const db = getDatabase(app);

    // ESCUTA EM TEMPO REAL
    const historicoRef = ref(db, 'mentoria/historico');
    
    onValue(historicoRef, (snapshot) => {
        const container = document.getElementById('feed-historico');
        container.innerHTML = "";
        const dados = snapshot.val();

        if (dados) {
            // Converte em array, limpa itens vazios e ordena pelo Timestamp (TS) mais recente
            const listaOrdenada = Object.keys(dados)
                .map(id => ({ id, ...dados[id] }))
                .sort((a, b) => (b.ts || 0) - (a.ts || 0));

            listaOrdenada.forEach(item => {
                const eHoje = item.data && item.data.includes('31/01/2026');
                const card = document.createElement('div');
                card.className = 'card-pdf';
                card.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        ${eHoje ? '<span class="status-hoje">ENVIADO HOJE</span>' : ''}
                        <span style="font-size:0.6rem; color:#64748b; font-weight:bold;">EXAME OAB</span>
                        <b style="font-size:1.1rem; color:#1e293b;">EXAME ${item.exame || '??'}</b>
                        <span style="font-size:0.7rem; color:#94a3b8;">${item.data || 'Sem data'}</span>
                    </div>
                    <button class="btn-revisar" onclick="revisar('${item.exame}')">REVISAR</button>
                `;
                container.appendChild(card);
            });
        } else {
            container.innerHTML = "<p style='text-align:center; color:#94a3b8; padding:20px;'>Cofre vazio. Envie uma peça!</p>";
        }
    });

    window.revisar = (ex) => {
        if(window.opener) {
            window.opener.localStorage.setItem('activeEx', ex);
            window.opener.location.reload();
            window.close();
        } else {
            alert("Abra pelo Cockpit principal para revisar.");
        }
    };
</script>
</body>
</html>
